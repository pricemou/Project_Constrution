<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <template id="Itineraire">
            <html lang="en">

            <head>
                <meta charset="UTF-8" />
                <meta http-equiv="X-UA-Compatible" content="IE=edge" />
                <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                <title>Itinéraire</title>
                <!-- Favicons -->
                <link rel="apple-touch-icon" href="/CashOutWeb/static/assets/img/favicons/apple-touch-icon.png"
                    sizes="180x180" />
                <link rel="icon" href="/CashOutWeb/static/assets/img/favicons/favicon-32x32.png" sizes="32x32"
                    type="image/png" />
                <link rel="icon" href="/CashOutWeb/static/assets/img/favicons/favicon-16x16.png" sizes="16x16"
                    type="image/png" />
                <link rel="mask-icon" href="/CashOutWeb/static/assets/img/favicons/safari-pinned-tab.svg"
                    color="#ffffff" />

                <!-- Elegant font icons -->
                <link href="/CashOutWeb/static/assets/vendor/elegant_font/HTMLCSS/style.css" rel="stylesheet" />

                <!-- Elegant font icons -->
                <link href="/CashOutWeb/static/assets/vendor/materializeicon/material-icons.css" rel="stylesheet" />

                <!-- Swiper Slider -->
                <link href="/CashOutWeb/static/assets/vendor/swiper/css/swiper.min.css" rel="stylesheet" />
                <link rel="stylesheet"
                    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
                <!-- Custom styles for this template -->
                <link href="/CashOutWeb/static/assets/css/style-blue.css" rel="stylesheet" id="style" />
                <link href="/CashOutWeb/static/assets/css/agence_maps.css " rel="stylesheet " id="style" />
                <link href="/CashOutWeb/static/assets/css/agence.css " rel="stylesheet " id="style" />
                <link href="/CashOutWeb/static/assets/css/styleIndicator.css" rel="stylesheet" />
                <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>

            </head>
            <header class="header fixed-top header-fill">
                <nav class="navbar">
                    <div>
                        <button class="menu-btn btn btn-link btn-44" onclick="window.history.go(-1); return false;">
                            <span class="icon material-icons">arrow_back</span>
                        </button>
                    </div>
                    <div>
                        <h6 class="text"><span>Itinéraire</span></h6>
                    </div>
                    <div>
                    </div>
                </nav>
            </header>

            <body>
                <div class=" diffg">
                    <section class="step-indicator ">
                        <div class="step step1">
                            <div class="step-icon">1</div>
                        </div>
                        <div class="indicator-line">

                        </div>
                        <div class="step step2">
                            <div class="step-icon">2</div>
                        </div>
                        <div class="indicator-line"></div>
                        <div class="step step3 active">
                            <div class="step-icon">3</div>
                        </div>
                        <div class="indicator-line  active"></div>
                        <div class="step step4">
                            <div class="step-icon">4</div>
                        </div>

                    </section>
                </div>



                <div id="map">
                </div>

                <!-- Required jquery and libraries -->
                <script src="/CashOutWeb/static/assets/js/jquery-3.3.1.min.js "></script>
                <script src="/CashOutWeb/static/assets/js/popper.min.js "></script>
                <script src="/CashOutWeb/static/assets/vendor/bootstrap-4.4.1/js/bootstrap.min.js "></script>

                <!-- cookie css -->

                <!-- Customized jquery file  -->
                <script src="/CashOutWeb/static/assets/js/main.js "></script>
                <script src="/CashOutWeb/static/assets/js/itineraire.js "></script>
                <script src="/CashOutWeb/static/assets/js/color-scheme-demo.js "></script>

                <script>
                    function initialize() {
                        var agence = <t t-esc='agence' /> ;
                        var $def_obj = $.Deferred();
                        var shipping_lat = parseFloat(agence.latitude);
                        var shipping_lng = parseFloat(agence.longitude);
                        var directionsService = new google.maps.DirectionsService;
                        var directionsDisplay = new google.maps.DirectionsRenderer;
                        const map = new google.maps.Map(document.getElementById("map"), {
                            zoom: 16,
                            mapTypeId: "roadmap",
                            center: {
                                lat: shipping_lat,
                                lng: shipping_lng
                            }

                        });
                        directionsDisplay.setMap(map);
                        calculateAndDisplayRoute(directionsService, directionsDisplay);
                        $def_obj.resolve(map);
                        initItineraryMap();

                        // function calcRoute(latStart, lngStart, latEnd, lngEnd) {
                        //     var waypts = [];


                        //     // stop = new google.maps.LatLng(-39.419, 175.57)
                        //     // waypts.push({
                        //     //     location: stop,
                        //     //     stopover: true
                        //     // });


                        //     start = new google.maps.LatLng(latStart, lngStart);
                        //     end = new google.maps.LatLng(latEnd, lngEnd);
                        //     var request = {
                        //         origin: start,
                        //         destination: end,
                        //         waypoints: waypts,
                        //         optimizeWaypoints: true,
                        //         travelMode: google.maps.DirectionsTravelMode.WALKING
                        //     };
                        //     directionsService.route(request, function (response, status) {
                        //         if (status == google.maps.DirectionsStatus.OK) {
                        //             directionsDisplay.setDirections(response);
                        //             var route = response.routes[0];

                        //         }
                        //     });
                        // }

                        //Delivery Boy location update
                        var flag = true;
                        var ajax_call = function () {
                            if (flag == true) {
                                calculateAndDisplayRoute(directionsService, directionsDisplay);
                                console.log("Map Reloaded");
                            };
                        };
                        if ($("#map")) {
                            var directionsService = new google.maps.DirectionsService;
                            var directionsDisplay = new google.maps.DirectionsRenderer;
                            $("#map").hover(
                                function () {
                                    flag = false;
                                },
                                function () {
                                    flag = true;
                                }
                            );
                            setInterval(ajax_call, 5000);
                            // initialize();
                        }

                        // Initialize and add the map
                        function initItineraryMap() {
                            var infoWindow = new google.maps.InfoWindow();
                            // The map, centered at customer

                            // Get user location
                            if (navigator.geolocation) {
                                navigator.geolocation.getCurrentPosition(
                                    (position) => {
                                        const pos = {
                                            lat: position.coords.latitude,
                                            lng: position.coords.longitude,
                                        };
                                        infoWindow.setPosition(pos);
                                        infoWindow.setContent("Vous êtes ici.");
                                        infoWindow.open(map);
                                        map.setCenter(pos);
                                        directionsDisplay.setMap(map);
                                        calculateAndDisplayRoute(directionsService, directionsDisplay, pos.lat, pos.lng, shipping_lat, shipping_lng);
                                        
                                        // The marker, positioned at customer
                                        // const marker = new google.maps.Marker({
                                        //     position: pos,
                                        //     map: map,
                                        //     label: {
                                        //         text: "Ma position",
                                        //         color: "black",
                                        //         fontSize: "10px",
                                        //         fontWeight: 'bold',
                                        //     },
                                        // });
                                    },
                                    () => {
                                        handleLocationError(true, infoWindow, map.getCenter());
                                    }, {
                                        enableHighAccuracy: true,
                                        timeout: 5000,
                                        maximumAge: 0
                                    });
                            } else {
                                // Browser doesn't support Geolocation
                                handleLocationError(false, infoWindow, map.getCenter());
                            }

                            const marker_agency = new google.maps.Marker({
                                position: {
                                    lat: parseFloat(agence.latitude),
                                    lng: parseFloat(agence.longitude)
                                },
                                map: map,
                                label: {
                                    text: String(agence.name),
                                    color: "black",
                                    fontSize: "10px",
                                    fontWeight: 'bold',
                                },
                            });

                            google.maps.event.addListener(marker_agency, 'click', function () {
                                alert('C\'est votre destination...')
                            });


                            const inputText = document.createElement("input")
                            inputText.type = "text";
                            inputText.placeholder = String(agence.name);
                            inputText.setAttribute("disabled", "");

                            map.controls[google.maps.ControlPosition.TOP_CENTER].push(inputText)
                        }
                        
                    };
                </script>
                <script
                    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCfVlxFRVtewNGVuvbt9jbF4LWW12ab-bw&amp;callback=initialize&amp;libraries=&amp;v=weekly">
                </script>

            </body>

            </html>

        </template>
    </data>
</odoo>