<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <template id="Itineraire">
            <html lang="en">

            <head>
                <meta charset="UTF-8" />
                <meta http-equiv="X-UA-Compatible" content="IE=edge" />
                <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                <title>Itinéraire</title>
               
                <!-- Elegant font icons -->
                <link href="/web_cash_out/static/assets/vendor/elegant_font/HTMLCSS/style.css" rel="stylesheet" />

                <!-- Elegant font icons -->
                <link href="/web_cash_out/static/assets/vendor/materializeicon/material-icons.css" rel="stylesheet" />

                <!-- Swiper Slider -->
                <link href="/web_cash_out/static/assets/vendor/swiper/css/swiper.min.css" rel="stylesheet" />
                <link rel="stylesheet"
                    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
                <!-- Custom styles for this template -->
                <link href="/web_cash_out/static/assets/css/style-blue.css" rel="stylesheet" id="style" />
                <link href="/web_cash_out/static/assets/css/agence_maps.css " rel="stylesheet " id="style" />
                <link href="/web_cash_out/static/assets/css/agence.css " rel="stylesheet " id="style" />
                <link href="/web_cash_out/static/assets/css/styleIndicator.css" rel="stylesheet" />
                <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>

            </head>
            <header class="header fixed-top header-fill">
                <nav class="navbar">
                    <div>
                        <button class="menu-btn btn btn-link btn-44" onclick="window.history.go(-1); return false;">
                            <span class="icon material-icons">arrow_back</span>
                        </button>
                    </div>
                    <div>
                        <h6 class="text"><span>Itinéraire</span></h6>
                    </div>
                    <div>
                    </div>
                </nav>
            </header>

            <body>

                <div id="map">
                </div>

                <div class="modal fade modals" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-cusom " role="document ">
                        <div class="modal-content modal-contens ">
                            <div class="modal-header modal-border head ">
                                <h5 class="modal-title " id="exampleModalLabel "> <span class="material-icons " data-dismiss="modal ">
                                    delete_forever
                                    </span>
                                </h5>
                            </div>
                            <div class="modal-body text-center ">
                                    <!-- <img class="image"/> -->
                                    <img  t-att-src="'/web/image?model=res.partner&amp;id=%s&amp;field=image_128' % id" class="image d-none" />
                                    <img  t-att-src="'/web/image?model=res.partner&amp;id=%s&amp;field=image_128' % agences.id" class="image" />

                            <h3></h3>
                                <p>Veuillez cliquez sur le bouton ci-dessous pour procéder au paiement</p>
                            </div>
                        
                            <div class="modal-footer modal-border buttons ">
                                <a href="https://moise.groupecerco.com/my"><button type="button " class="btn btn-dark validers " id="validerTrager">Procéder au paiement</button></a>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- Required jquery and libraries -->
                <script src="/web_cash_out/static/assets/js/jquery-3.3.1.min.js "></script>
                <script src="/web_cash_out/static/assets/js/popper.min.js "></script>
                <script src="/web_cash_out/static/assets/vendor/bootstrap-4.4.1/js/bootstrap.min.js "></script>

                <!-- cookie css -->

                <!-- Customized jquery file  -->
                <script src="/web_cash_out/static/assets/js/main.js "></script>
                <script src="/web_cash_out/static/assets/js/itineraire.js "></script>
                <script src="/web_cash_out/static/assets/js/color-scheme-demo.js "></script>

                <script>
                    var agence = <t t-esc='agence' /> ;
                    var distance_stored = sessionStorage.getItem('distance');
                    var global_latitude = sessionStorage.getItem('latitude');
                    var global_longitude = sessionStorage.getItem('longitude');
                    function initialize() {
                        var $def_obj = $.Deferred();
                        var shipping_lat = parseFloat(agence.latitude);
                        var shipping_lng = parseFloat(agence.longitude);
                        var directionsService = new google.maps.DirectionsService;
                        var directionsDisplay = new google.maps.DirectionsRenderer;
                        const map = new google.maps.Map(document.getElementById("map"), {
                            zoom: 16,
                            mapTypeId: "roadmap",
                            center: {
                                lat: shipping_lat,
                                lng: shipping_lng
                            }

                        });
                        directionsDisplay.setMap(map);
                        $def_obj.resolve(map);
                        initItineraryMap();

                        //Delivery Boy location update
                        function ajax_call() {                                            
                            if (global_latitude){
                                initItineraryMap();
                            } else {
                                initItineraryMap();
                            }
                            console.log("Map Reloaded");
                        };
                        setInterval(ajax_call, 10000);

                        // Initialize and add the map
                        function initItineraryMap() {
                            var infoWindow = new google.maps.InfoWindow();
                            // The map, centered at customer

                            // Get user location
                            if (navigator.geolocation) {
                                navigator.geolocation.getCurrentPosition(
                                    (position) => {
                                        const pos = {
                                            lat: position.coords.latitude,
                                            lng: position.coords.longitude,
                                        };
                                        infoWindow.setPosition(pos);
                                        infoWindow.setContent("Vous êtes ici.");
                                        infoWindow.open(map);
                                        map.setCenter(pos);
                                        directionsDisplay.setMap(map);
                                        calculateAndDisplayRoute(directionsService, directionsDisplay, pos.lat, pos.lng, shipping_lat, shipping_lng);
                                        sessionStorage.setItem("pos", pos);
                                        sessionStorage.setItem("latitude", pos.lat);
                                        sessionStorage.setItem("longitude", pos.lng);
                                        var distance = google.maps.geometry.spherical.computeDistanceBetween(pos, new google.maps.LatLng(agence.latitude, agence.longitude));
                                        console.log("DISTANCE: "+ String(distance));
                                        sessionStorage.setItem('distance', parseFloat(distance));
                                        openModal(agence, distance);
                                        
                                        // The marker, positioned at customer
                                        // const marker = new google.maps.Marker({
                                        //     position: pos,
                                        //     map: map,
                                        //     label: {
                                        //         text: "Ma position",
                                        //         color: "black",
                                        //         fontSize: "10px",
                                        //         fontWeight: 'bold',
                                        //     },
                                        // });
                                    },
                                    () => {
                                        handleLocationError(true, infoWindow, map.getCenter());
                                    }, {
                                        enableHighAccuracy: true,
                                        timeout: 10000,
                                        maximumAge: 0
                                    });
                            } else {
                                // Browser doesn't support Geolocation
                                handleLocationError(false, infoWindow, map.getCenter());
                            }

                            const marker_agency = new google.maps.Marker({
                                position: {
                                    lat: parseFloat(agence.latitude),
                                    lng: parseFloat(agence.longitude)
                                },
                                map: map,
                                label: {
                                    text: String(agence.name),
                                    color: "black",
                                    fontSize: "10px",
                                    fontWeight: 'bold',
                                },
                            });

                            google.maps.event.addListener(marker_agency, 'click', function () {
                                alert('C\'est votre destination...')
                            });


                            const inputText = document.createElement("input")
                            inputText.type = "text";
                            inputText.placeholder = String(agence.name);
                            inputText.setAttribute("disabled", "");

                            map.controls[google.maps.ControlPosition.TOP_CENTER].push(inputText)
                        }
                        
                    };
                </script>
                <script
                    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCfVlxFRVtewNGVuvbt9jbF4LWW12ab-bw&amp;callback=initialize&amp;libraries=geometry&amp;v=weekly">
                </script>

            </body>

            </html>

        </template>
    </data>
</odoo>